services:

  mediamtx:
    image: bluenviron/mediamtx:latest
    container_name: mediamtx-server
    hostname: mediamtx
    ports:
      - "8554:8554"      # RTSP
      - "1935:1935"      # RTMP
      - "8888:8888"      # HLS/HTTP
      - "8889:8889"      # WebRTC
      - "8890:8890/udp"  # WebRTC UDP
      - "8189:8189/udp"  # WebRTC UDP
    environment:
      - MTX_RTSPTRANSPORTS=tcp  # RTSPトランスポートをTCPに設定
    restart: unless-stopped

  nginx:
    image: nginx:latest
    container_name: nginx-server
    hostname: nginx
    ports:
      - "80:80"      # HTTP
      - "443:443"    # HTTPS
    volumes:
      # Do not mount an empty host conf.d (hides the image's default config).
      # If you need custom nginx configs, place them under ./nginx/conf.d and
      # ensure files exist before starting the container.
      - ./nginx/certs:/etc/nginx/certs:ro
      - ./snapshots:/usr/share/nginx/html/snapshots:ro
    depends_on:
      - mediamtx
    restart: unless-stopped

  ffmpeg-relay-1:
    build: ./ffmpeg-relay
    container_name: ffmpeg-relay-1
    hostname: ffmpeg-relay-1
    depends_on:
      - mediamtx
    environment:
      - INPUT_RTSP_HOST=${RELAY1_INPUT_HOST}
      - INPUT_RTSP_PORT=${RELAY1_INPUT_PORT}
      - INPUT_RTSP_PATH=${RELAY1_INPUT_PATH}
      - OUTPUT_RTSP_HOST=${MEDIAMTX_RTSP_HOST}
      - OUTPUT_RTSP_PORT=${MEDIAMTX_RTSP_PORT}
      - OUTPUT_RTSP_PATH=${RELAY1_OUTPUT_PATH}
      - BUFFER_SIZE=${BUFFER_SIZE:-256M}
      - MAX_DELAY=${MAX_DELAY:-60000000}
      - THREAD_QUEUE_SIZE=${THREAD_QUEUE_SIZE:-2048}
      - TZ=${TIMEZONE:-Asia/Tokyo}
    network_mode: host  # ホストネットワークを使用
    restart: unless-stopped
    ulimits:
      memlock: -1
      nofile: 65536
    mem_limit: ${MEMORY_LIMIT}
    shm_size: ${SHM_SIZE}
    volumes:
      - ./snapshots:/var/www/snapshots:rw

#  ffmpeg-relay-2:
#    build: ./ffmpeg-relay
#    container_name: ffmpeg-relay-2
#    hostname: ffmpeg-relay-2
#    depends_on:
#      - mediamtx
#    environment:
#      - INPUT_RTSP_HOST=${RELAY2_INPUT_HOST}
#      - INPUT_RTSP_PORT=${RELAY2_INPUT_PORT}
#      - INPUT_RTSP_PATH=${RELAY2_INPUT_PATH}
#      - OUTPUT_RTSP_HOST=${MEDIAMTX_RTSP_HOST}
#      - OUTPUT_RTSP_PORT=${MEDIAMTX_RTSP_PORT}
#      - OUTPUT_RTSP_PATH=${RELAY2_OUTPUT_PATH}
#      - BUFFER_SIZE=${BUFFER_SIZE:-256M}
#      - MAX_DELAY=${MAX_DELAY:-60000000}
#      - THREAD_QUEUE_SIZE=${THREAD_QUEUE_SIZE:-2048}
#      - TZ=${TIMEZONE:-Asia/Tokyo}
#    network_mode: host  # ホストネットワークを使用
#    restart: unless-stopped
#    ulimits:
#      memlock: -1
#      nofile: 65536
#    mem_limit: ${MEMORY_LIMIT}
#    shm_size: ${SHM_SIZE}
#    volumes:
#      - ./snapshots:/var/www/snapshots:rw



